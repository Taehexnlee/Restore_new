# Restore

Restore is a full-stack e-commerce sample that combines an ASP.NET Core 8 API with a React 19 + Vite frontend. It showcases a modern shopping experience with product discovery, a persistent basket, Stripe-powered checkout, and authenticated order management.

## Features
- Product catalog with search, sort, multi-select filters, and cursor-free pagination.
- Cookie-backed basket that survives refreshes and syncs across tabs.
- Secure checkout flow with Stripe PaymentIntents, Elements UI, and webhook reconciliation.
- Account management using ASP.NET Identity cookie authentication and role seeding.
- Order history with detailed receipts, status updates, and inventory backfill on failures.

## Tech Stack
- Backend: .NET 8, ASP.NET Core, Entity Framework Core (SQL Server), ASP.NET Identity, Stripe.NET.
- Frontend: React 19, Vite, TypeScript, Material UI, Redux Toolkit + RTK Query, React Hook Form, Zod, Stripe Elements.
- Tooling & Ops: Docker (SQL Server), Vite mkcert for HTTPS dev certificates.

## Project Layout
```
.
|-- API/                # ASP.NET Core backend (serves API + static client build)
|-- client/             # React front-end (outputs to API/wwwroot on build)
|-- docker-compose.yml  # Local SQL Server instance (MSSQL 2022)
|-- Restore.sln         # .NET solution aggregating projects
```

## Prerequisites
- .NET 8 SDK
- Node.js 20+ and npm (or another Node package manager)
- Docker Desktop (to run the SQL Server container) or access to a SQL Server instance
- Stripe account and Stripe CLI (for local webhook testing)
- mkcert installed locally so Vite can generate HTTPS certificates (`npm install -g mkcert` if needed)

## Setup

### 1. Database and configuration
1. Copy the sample settings and adjust secrets:
   ```bash
   cp API/appsettings.Development.json.example API/appsettings.Development.json
   ```
2. Update `ConnectionStrings:DefaultConnection` if you are not using the bundled Docker SQL instance.
3. Fill in your Stripe keys inside `StripeSettings`:
   ```json
   {
     "StripeSettings": {
       "PublishableKey": "pk_test_xxx",
       "SecretKey": "sk_test_xxx",
       "WebhookSecret": "whsec_xxx"
     }
   }
   ```
4. Start SQL Server (adjust platform flag if you are not on Apple Silicon):
   ```bash
   docker compose up sql -d
   ```

### 2. Backend (API)
```bash
cd API
dotnet restore
dotnet watch run
```
- The API listens on `https://localhost:5001` (Kestrel dev cert) and `http://localhost:5000` by default.
- `DbInitializer` runs on startup, applies EF Core migrations, seeds catalog data, and creates default users:
  - `admin@test.com` / `Pa$$w0rd` (roles: Member, Admin)
  - `bob@test.com`   / `Pa$$w0rd` (role: Member)

### 3. Frontend (client)
```bash
cd client
npm install
```
Create `client/.env.local` (Vite picks this up automatically):
```
VITE_API_URL=https://localhost:5001/api
VITE_STRIPE_PK=pk_test_xxx
```
Run the dev server (serves on `https://localhost:3000` with mkcert):
```bash
npm run dev
```

### 4. Stripe webhooks (optional but recommended)
Use the Stripe CLI to forward events to the API while testing checkout flows:
```bash
stripe listen --forward-to https://localhost:5001/api/payments/webhook
```

## Build & Deployment
- To create a production build of the client that the API can serve:
  ```bash
  cd client
  npm run build
  ```
  The generated assets land in `API/wwwroot`, allowing the ASP.NET app to serve the SPA directly.
- Publish the API as usual (for example `dotnet publish -c Release`) and deploy alongside the SQL database and your Stripe secrets.

## Useful Commands
- `dotnet watch run` – hot reload for the API.
- `dotnet ef migrations add <Name>` – add new migrations (requires `dotnet-ef` tool if not installed).
- `npm run dev` / `npm run build` / `npm run lint` – Vite dev server, production build, ESLint.
- `docker compose down` – stop and remove the local SQL container.

## Notes & Troubleshooting
- The frontend talks to the API using secure cookies; ensure both the API and Vite dev server are running over HTTPS so cookies are sent.
- If Stripe Elements shows a certificate warning, trust the local certificate generated by mkcert.
- Seeded users are for local development only; change passwords and secrets before going live.

Happy hacking!
